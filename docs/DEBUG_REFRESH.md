# 🔍 刷新功能调试指南

## 如何测试刷新功能

### 1. 打开开发者工具

在浏览器中按 `F12` 或 `Cmd+Option+I` (Mac) 打开开发者工具，切换到 **Console** 标签。

### 2. 观察日志输出

现在代码中添加了详细的日志，您会看到：

#### 自动刷新日志（每10秒）
```
⏰ 自动刷新开始 - 15:30:45
  站点 Home 371: 1 条线路
  站点 SengKang 371: 1 条线路
```

#### 手动刷新日志（点击刷新按钮时）
```
🔄 刷新站点: Home 371 (67661)
✅ 获取到数据: {services: [...]}
🚌 过滤后的线路: [{
  no: "371",
  next: "120秒",
  next2: "450秒",
  next3: "780秒"
}]
```

### 3. 检查数据是否变化

#### 方法 1: 观察时间戳
刷新前记录一个时间，刷新后看日志中的时间是否变化。

#### 方法 2: 观察具体数值
在日志中查看 `next: "XXX秒"` 的值，两次刷新之间应该会减少。

例如：
- 第一次刷新: `next: "120秒"`
- 10秒后再刷新: `next: "110秒"` ✅ 正常
- 如果还是 `next: "120秒"` ❌ 数据没变

### 4. 检查 API 响应

在开发者工具的 **Network** 标签：
1. 筛选 `bus-arrival`
2. 点击刷新按钮
3. 查看请求是否发送
4. 查看响应数据中的 `duration_ms` 是否在变化

---

## 可能的问题和原因

### 问题 1: 数据确实没变化 ✅ 正常

如果公交车还没发车或者位置没变，`duration_ms` 可能确实不变：
- 公交车停在始发站等待发车
- 公交车刚好在某个站点停留
- 数据源本身更新不频繁

**如何验证**:
等待 30-60 秒后再刷新，如果时间缩短了说明数据在更新。

---

### 问题 2: 缓存问题 ❌ 需要修复

API 可能被缓存，导致获取的是旧数据。

**检查方法**:
查看 Network 标签中的请求：
- 如果显示 `(disk cache)` 或 `(memory cache)` → 被缓存了
- 如果显示状态码 `200` 且有响应时间 → 正常

**解决方案**:
API 路由中已经设置了 `cache: 'no-store'`，但可以添加时间戳：

```typescript
fetch(`/api/bus-arrival?code=${code}&t=${Date.now()}`)
```

---

### 问题 3: 显示问题 ❌ 需要修复

数据更新了，但页面显示没变化。

**检查方法**:
1. 在 Console 中查看日志，确认数据变了
2. 但页面上的时间没变

**可能原因**:
- React 状态没有正确更新
- Key 值导致组件没有重新渲染

---

### 问题 4: 时区问题 ⚠️ 注意

API 返回的时间是新加坡时区 `+08:00`，如果您在其他时区测试，时间可能看起来不准。

---

## 详细调试步骤

### 步骤 1: 确认 API 正常

在浏览器中直接访问：
```
http://localhost:3000/api/bus-arrival?code=67661
```

多次刷新，观察 `duration_ms` 是否变化。

**预期结果**:
```json
{
  "services": [{
    "no": "371",
    "next": {
      "duration_ms": 120000  // 这个值应该会变化
    }
  }]
}
```

---

### 步骤 2: 测试手动刷新

1. 打开主页
2. 打开 Console
3. 点击一个站点的刷新按钮
4. 观察日志输出

**正常日志示例**:
```
🔄 刷新站点: Home 371 (67661)
✅ 获取到数据: {services: Array(1)}
🚌 过滤后的线路: [{no: "371", next: "120秒", ...}]
```

**异常情况**:
- 没有日志 → 按钮点击事件没触发
- 有错误信息 → API 调用失败
- 数据显示但值不变 → 可能是数据源问题

---

### 步骤 3: 对比自动刷新

1. 等待 10 秒让自动刷新触发
2. 观察 Console 日志
3. 对比自动刷新和手动刷新的数据

**对比要点**:
- 同一站点、同一时间的 `duration_ms` 应该相近
- 时间间隔后的值应该减少

---

### 步骤 4: 检查页面渲染

在 Console 中运行：
```javascript
// 查看当前显示的数据
console.log('当前 busLines:', 
  document.querySelectorAll('.bus-card').length
);
```

---

## 快速测试脚本

在 Console 中运行以下代码，监控数据变化：

```javascript
// 记录初始数据
let initialData = null;

// 每次刷新后对比
window.addEventListener('click', (e) => {
  if (e.target.closest('button[title="刷新此站点"]')) {
    setTimeout(() => {
      const timeDisplays = document.querySelectorAll('.time-display');
      const currentData = Array.from(timeDisplays).map(el => el.textContent);
      
      if (initialData) {
        console.log('📊 数据对比:');
        console.log('  刷新前:', initialData);
        console.log('  刷新后:', currentData);
        console.log('  是否变化:', 
          JSON.stringify(initialData) !== JSON.stringify(currentData)
        );
      }
      
      initialData = currentData;
    }, 1000);
  }
});

console.log('✅ 监控已启动，点击刷新按钮测试');
```

---

## 常见问题排查

### Q1: 点击刷新按钮没反应？

**检查**:
1. 按钮是否在旋转？（说明请求已发送）
2. Console 有日志吗？
3. Network 标签有请求吗？

**可能原因**:
- JavaScript 错误
- 按钮被禁用
- 网络问题

---

### Q2: 有日志但时间没变？

**这可能是正常的**！原因：
- 公交车还没发车
- 刷新间隔太短（少于 5 秒）
- 数据源更新周期较长

**验证方法**:
等待 1 分钟后再刷新对比。

---

### Q3: 自动刷新正常，手动刷新不变？

**检查代码逻辑**:
- `refreshSingleStop` 函数是否正确
- `setBusLines` 是否被正确调用

**添加更多日志**:
```typescript
console.log('更新前:', prevLines);
console.log('更新后:', allLines);
```

---

### Q4: Network 显示 304 Not Modified？

**这是缓存问题**！

**解决方案**:
1. 在 `busApi.ts` 中添加时间戳
2. 或者强制刷新（Ctrl+Shift+R）

---

## 数据源特性

### ArriveLah2 API 更新频率

- **实时位置** (monitored=1): 约每 10-30 秒更新
- **预计时间** (monitored=0): 基于时刻表，可能不常变

### duration_ms 的计算

```
duration_ms = 到站时间 - 当前时间

示例:
当前时间: 15:30:00
到站时间: 15:32:00
duration_ms: 120000 (120秒)

过 10 秒后:
当前时间: 15:30:10
到站时间: 15:32:00
duration_ms: 110000 (110秒) ✅ 减少了
```

---

## 预期行为

### 正常情况

| 时间 | 操作 | duration_ms | 显示 |
|------|------|-------------|------|
| 15:30:00 | 首次加载 | 120000 | 2分0秒 |
| 15:30:10 | 手动刷新 | 110000 | 1分50秒 ✅ |
| 15:30:20 | 自动刷新 | 100000 | 1分40秒 ✅ |

### 异常情况

| 时间 | 操作 | duration_ms | 显示 |
|------|------|-------------|------|
| 15:30:00 | 首次加载 | 120000 | 2分0秒 |
| 15:30:10 | 手动刷新 | 120000 | 2分0秒 ❌ |
| 15:30:20 | 自动刷新 | 120000 | 2分0秒 ❌ |

如果出现异常情况，说明：
1. API 返回的数据没变（数据源问题）
2. 或者缓存问题
3. 或者时间计算有误

---

## 建议的调试流程

1. ✅ 打开 Console 和 Network
2. ✅ 点击刷新按钮
3. ✅ 检查 Console 日志
4. ✅ 检查 Network 请求
5. ✅ 对比 API 返回的 duration_ms
6. ✅ 等待 30 秒后再次刷新对比

---

**如果按照以上步骤还是有问题，请提供**:
- Console 日志截图
- Network 请求截图
- 具体的时间数值对比

