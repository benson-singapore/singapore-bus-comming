# 🔄 刷新功能使用指南

## 功能概述

本应用提供了**两种刷新方式**，让您随时获取最新的公交到站信息：

### 1. 自动刷新 ⏰
- **频率**: 每5秒自动刷新
- **范围**: 刷新所有监控的站点
- **特点**: 无需操作，后台自动运行

### 2. 手动刷新 🔄（新功能！）
- **位置**: 每个站点卡片右上角
- **范围**: 只刷新点击的站点
- **特点**: 立即响应，精准控制

---

## 刷新按钮详解

### 按钮位置

刷新按钮位于每个公交线路卡片的**右上角**，与线路号在同一行：

```
┌──────────────────────────────────┐
│  371路                    🔄    │  ← 刷新按钮在这里
│  深圳湾公园站                     │
├──────────────────────────────────┤
│  当前一趟    🔴 即将到站          │
│  1分20秒     📍 实时位置          │
│  ████████░░░░░░░░ 80%           │
└──────────────────────────────────┘
```

### 按钮外观

| 状态 | 外观 | 说明 |
|------|------|------|
| **正常** | 🔄 白色半透明圆形 | 可以点击 |
| **Hover** | 🔄 白色稍深圆形 | 鼠标悬停 |
| **刷新中** | ↻ 旋转动画 | 正在获取数据 |
| **禁用** | 🔄 灰色 | 不可点击 |

### 按钮功能

1. **单击刷新**: 点击一次立即刷新该站点
2. **视觉反馈**: 显示旋转动画
3. **防重复**: 刷新中不可重复点击
4. **快速响应**: 通常1秒内完成

---

## 使用场景

### 场景 1: 等车时查看最新信息 🚌

**情况**: 你在公交站等车，想知道公交是否快到了

**操作步骤**:
1. 打开应用
2. 找到对应的站点卡片
3. 点击右上角的刷新按钮 🔄
4. 等待0.5-1秒
5. 查看最新的到站时间

**优势**: 不需要等5秒自动刷新，立即获取最新数据

---

### 场景 2: 验证倒计时准确性 ⏱️

**情况**: 倒计时显示"2分钟"，但你觉得可能不准

**操作步骤**:
1. 点击刷新按钮
2. 系统重新获取数据
3. 对比刷新前后的时间
4. 确认实际到站时间

**优势**: 快速验证数据，做出准确判断

---

### 场景 3: 多站点选择性刷新 🎯

**情况**: 监控了3个站点，只想更新其中1个

**操作步骤**:
1. 找到需要更新的站点卡片
2. 只点击该站点的刷新按钮
3. 其他站点保持不变

**优势**: 
- 节省流量
- 减少不必要的请求
- 精准控制

---

### 场景 4: 网络恢复后手动刷新 📶

**情况**: 之前网络断开，现在恢复了

**操作步骤**:
1. 逐个点击站点的刷新按钮
2. 或者等待5秒自动刷新
3. 确认所有数据已更新

**优势**: 主动恢复数据，不需要刷新整个页面

---

## 刷新机制说明

### 自动刷新流程

```
页面加载
    ↓
读取本地配置
    ↓
获取所有站点数据
    ↓
显示在页面上
    ↓
⏰ 等待 5 秒
    ↓
重新获取数据 ←──┐
    ↓             │
更新页面显示      │
    └─────────────┘
```

### 手动刷新流程

```
用户点击刷新按钮
    ↓
标记该站点为"刷新中"
    ↓
显示旋转动画
    ↓
调用 API 获取数据
    ↓
只更新该站点的数据
    ↓
停止旋转动画
    ↓
清除"刷新中"标记
```

---

## 技术特点

### 1. 智能更新 🧠

**部分更新策略**:
- 手动刷新只更新指定站点
- 不影响其他站点的数据
- 不重置倒计时
- 保持页面流畅

**实现方式**:
```typescript
setBusLines(prevLines => {
  // 保留其他站点的数据
  const otherLines = prevLines.filter(
    line => !(line.stopCode === stopCode && line.stopId === stopId)
  );
  
  // 添加刷新后的数据
  return [...otherLines, ...newLines];
});
```

### 2. 防抖机制 ⏱️

**最少加载时间**: 500ms
- 即使数据在100ms内返回
- 也会显示500ms的加载动画
- 避免闪烁，提供更好的视觉反馈

**实现方式**:
```typescript
setTimeout(() => {
  setRefreshingStops(prev => {
    const next = new Set(prev);
    next.delete(`${stopId}-${stopCode}`);
    return next;
  });
}, 500);
```

### 3. 错误处理 ⚠️

**失败情况**:
- 网络错误
- API 超时
- 无效数据

**处理方式**:
- 在控制台记录错误
- 不影响页面显示
- 5秒后自动刷新会重试

---

## 性能对比

### 刷新性能测试

| 指标 | 自动刷新 | 手动刷新 |
|------|----------|----------|
| **响应时间** | 0-5秒 | 立即 |
| **API 请求** | 所有站点 | 单个站点 |
| **流量消耗** | 高 | 低 |
| **用户控制** | 无 | 高 |

### 使用建议

| 场景 | 推荐方式 |
|------|----------|
| 日常监控 | ⏰ 自动刷新 |
| 需要最新数据 | 🔄 手动刷新 |
| 等车时 | 🔄 手动刷新 |
| 多站点监控 | ⏰ 自动刷新 |
| 验证数据 | 🔄 手动刷新 |
| 网络恢复 | 🔄 手动刷新 |

---

## 常见问题

### Q1: 为什么自动刷新改成5秒？

**A**: 
- 公交数据实时性要求高
- 5秒能及时反映变化
- 平衡实时性和服务器压力
- 不会造成明显的流量消耗

### Q2: 手动刷新会中断自动刷新吗？

**A**: 不会！
- 手动刷新是一次性操作
- 自动刷新的定时器继续运行
- 两者互不影响

### Q3: 可以同时刷新多个站点吗？

**A**: 可以！
- 快速点击多个站点的刷新按钮
- 每个站点独立刷新
- 并发执行，互不干扰

### Q4: 刷新按钮点击没反应？

**可能原因**:
1. 正在刷新中（查看是否有旋转动画）
2. 网络问题（检查网络连接）
3. API 错误（查看控制台）

**解决方法**:
1. 等待当前刷新完成
2. 检查网络连接
3. 刷新整个页面

### Q5: 可以自定义刷新频率吗？

**A**: 可以！
修改代码中的刷新间隔：

```typescript
// 在 src/app/page.tsx 中找到这一行
const interval = setInterval(fetchAllBusData, 5000); // 5000 = 5秒

// 改成你想要的值，例如：
const interval = setInterval(fetchAllBusData, 10000); // 10秒
const interval = setInterval(fetchAllBusData, 3000);  // 3秒
```

---

## 高级技巧

### 技巧 1: 快速刷新所有站点

虽然没有"全部刷新"按钮，但可以：
1. 快速点击所有站点的刷新按钮
2. 或者刷新浏览器页面（F5）
3. 或者等待5秒自动刷新

### 技巧 2: 观察刷新状态

打开浏览器开发者工具（F12）：
- **Network** 标签：查看 API 请求
- **Console** 标签：查看刷新日志
- 可以看到每次刷新的详细信息

### 技巧 3: 移动端使用

在手机上：
- 刷新按钮足够大，方便点击
- 旋转动画流畅
- 触摸反馈良好

---

## 总结

### 刷新功能的优势

✅ **双重保障**: 自动 + 手动，确保数据最新  
✅ **灵活控制**: 想刷新哪个就刷新哪个  
✅ **快速响应**: 不需要等待自动刷新  
✅ **视觉反馈**: 旋转动画明确告知状态  
✅ **智能更新**: 只更新需要的数据  
✅ **稳定可靠**: 错误处理完善  

### 使用建议

| 情况 | 建议 |
|------|------|
| 🏠 在家查看 | 依赖自动刷新 |
| 🚌 站台等车 | 使用手动刷新 |
| ⏰ 快迟到了 | 频繁手动刷新 |
| 📱 流量有限 | 减少手动刷新 |
| 🔋 省电模式 | 关闭应用，需要时再打开 |

---

**享受更便捷的公交监控体验！** 🎉

